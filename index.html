<!DOCTYPE html>
<html>
<head>
    <title>BCB Bike Tags</title>
    
    <!-- Script for parsing csv to JSON -->
    <script src="papaparse.min.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <!-- Script for Leaflet, make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <!-- Radar layer CSS & Script -->
    <link rel="stylesheet" href="leaflet-radar.css"></script>
    <script src="leaflet-radar.js"></script>
    
    <!-- Leaflet sidebar CSS -->
    <link rel="stylesheet" href="L.Control.Sidebar.css">
    <!-- <link rel="stylesheet" href="leaflet-sidebar.css"> -->
    <!-- Script for Leaflet sidebar -->
    <script src="L.Control.Sidebar.js"></script>
    <!-- <script src="leaflet-sidebar.js"></script> -->

    <!-- CDN for MapBox GL JS & CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>

    <!--   CDN for leaflet pinSearch   -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.pinsearch/src/Leaflet.PinSearch.css" crossorigin="">

    <!--   CDN for Leaflet.markercluster   -->
    <link rel="stylesheet" href="MarkerCluster.css">
    <link rel="stylesheet" href="MarkerCluster.Default.css">
    <script src="leaflet.markercluster-src.js"></script>

</head>

<body>
    <div id="map" style="height: 100vh; width: 100%;"></div>
    
    <script src="https://unpkg.com/leaflet.pinsearch/src/Leaflet.PinSearch.js" crossorigin=""></script>
    
    <div id="sidebar" class="sidebar collapsed">
        <h2>Tag Details</h2>
        <p>Tag Name: <a id="location-name"></a></p>
        <p>Tag Number: <a id="tag-number"></a></p>
        <p>Tag Date: <a id="tag-date"></a></p>
        <p>Claim Date: <a id="claim-date"></a></p>
        <img id="mystery-photo"
        src="https://biketagbcb.s3.us-east-2.amazonaws.com/no%20photo.png?response-content-disposition=inline&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMiJGMEQCIE0A1OuCGY%2BRg6uhsY0M9ieiW2liE%2F%2Fm4xzs4UdhUDvCAiBvv8ohQO%2BkYeArufHRb1eh1hxMgc0ZQ6d5hndTtyzzpSrtAgia%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAAaDDg5MTM3Njk4NDc4NyIM6CENxbQ6W5s%2FSOCbKsECQM3vap9U45WHFrKSxOdJumP3wyECW5INC3I4lfFvQaqLFovvnH90u9rkh7cx4Lr5hMNjpOWyyvdWU20MnMSwNr1z9X8dLIsJg4OYS0rcXwGIaLoE9WD3LyfwmEbHvB%2Fa4%2FlfzKhGfmU6flJNy9k727K3VAQ6Xl%2BM1K8d9fzitdISyvAr%2FpWkrocC6ZgrWw0Xuft%2BY9N9ZZsywnY%2FEG9JLCAVBYri5vjTOvzkl54Lae5tUEI%2BrDpUf7oM%2FUpjons2mNB6uNVJS%2FgcJebDbBPKHjjXL8JGd65u3Hd%2FiuAbodjnlqlzwzTGEkujn%2FPU5Wm1o%2BLiaNCA%2F4fnQw85Mo68kFFKsb6B2poEsHf4ImL5SQvSw8IWl1d%2BMIUJR%2FIZ2U6k3grfr%2F2Ml9gq4tGSxd%2F54CjAUQYVcFH2Ncu1IoyzC3qtMI6%2BiLAGOrQCAeQ20BPFsXlIwirQGdQtmsdTdIZ3rj9BrgSdsReo4ng%2FO4VPnO9ajjo3AeYDUl8f84o7twOHRDsvQe799mCLSPAkCAao4AHOVJMjD4ZFbFYUeaH5dQ7gUlDPdKF62rtniqd3djxRlhrOD3DbKp1PjwtEJLHl%2F5DDc60Hw6ssrMLbwg4CSDdB%2Fer%2Flo8qf5vrN5KKg8v2BixbqqwxgpEiOPNgodCmmSz1SJDPhIbGbVMg%2FZ%2Fkq1HtHu5Kc5e4KWmT%2BNRMADQpQsbzvCuiDrFTbxQG5BzbW3%2F06eo%2BR8Y9EevxmTuw2ik9yTUMNt4IR%2F%2BHBcPIKcVkW5JiCitoP%2FvLNYET7I2cM%2BAviYbo9%2F7AydLYtLxQkpo8oFXcm%2FeWCPjI8GQ2WjJSEM2jcUscClkRk%2BbnhtM%3D&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20240326T021743Z&X-Amz-SignedHeaders=host&X-Amz-Expires=3600&X-Amz-Credential=ASIA47CRVMLJSGWHUWO7%2F20240326%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Signature=6f6e5daa7403b3532d28548503d0fe871cbdc6f01a7a397ef347ef5b5e5a4b45"
        alt="Mystery Photo">
        <img id="claim-photo"
        src="https://biketagbcb.s3.us-east-2.amazonaws.com/no%20photo.png?response-content-disposition=inline&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMiJGMEQCIE0A1OuCGY%2BRg6uhsY0M9ieiW2liE%2F%2Fm4xzs4UdhUDvCAiBvv8ohQO%2BkYeArufHRb1eh1hxMgc0ZQ6d5hndTtyzzpSrtAgia%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAAaDDg5MTM3Njk4NDc4NyIM6CENxbQ6W5s%2FSOCbKsECQM3vap9U45WHFrKSxOdJumP3wyECW5INC3I4lfFvQaqLFovvnH90u9rkh7cx4Lr5hMNjpOWyyvdWU20MnMSwNr1z9X8dLIsJg4OYS0rcXwGIaLoE9WD3LyfwmEbHvB%2Fa4%2FlfzKhGfmU6flJNy9k727K3VAQ6Xl%2BM1K8d9fzitdISyvAr%2FpWkrocC6ZgrWw0Xuft%2BY9N9ZZsywnY%2FEG9JLCAVBYri5vjTOvzkl54Lae5tUEI%2BrDpUf7oM%2FUpjons2mNB6uNVJS%2FgcJebDbBPKHjjXL8JGd65u3Hd%2FiuAbodjnlqlzwzTGEkujn%2FPU5Wm1o%2BLiaNCA%2F4fnQw85Mo68kFFKsb6B2poEsHf4ImL5SQvSw8IWl1d%2BMIUJR%2FIZ2U6k3grfr%2F2Ml9gq4tGSxd%2F54CjAUQYVcFH2Ncu1IoyzC3qtMI6%2BiLAGOrQCAeQ20BPFsXlIwirQGdQtmsdTdIZ3rj9BrgSdsReo4ng%2FO4VPnO9ajjo3AeYDUl8f84o7twOHRDsvQe799mCLSPAkCAao4AHOVJMjD4ZFbFYUeaH5dQ7gUlDPdKF62rtniqd3djxRlhrOD3DbKp1PjwtEJLHl%2F5DDc60Hw6ssrMLbwg4CSDdB%2Fer%2Flo8qf5vrN5KKg8v2BixbqqwxgpEiOPNgodCmmSz1SJDPhIbGbVMg%2FZ%2Fkq1HtHu5Kc5e4KWmT%2BNRMADQpQsbzvCuiDrFTbxQG5BzbW3%2F06eo%2BR8Y9EevxmTuw2ik9yTUMNt4IR%2F%2BHBcPIKcVkW5JiCitoP%2FvLNYET7I2cM%2BAviYbo9%2F7AydLYtLxQkpo8oFXcm%2FeWCPjI8GQ2WjJSEM2jcUscClkRk%2BbnhtM%3D&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20240326T021743Z&X-Amz-SignedHeaders=host&X-Amz-Expires=3600&X-Amz-Credential=ASIA47CRVMLJSGWHUWO7%2F20240326%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Signature=6f6e5daa7403b3532d28548503d0fe871cbdc6f01a7a397ef347ef5b5e5a4b45"
        alt="Claim Photo">
    </div>

    <script>
        // Creating the leaflet map, with coordinates of center of view and zoom level
        var map = L.map('map').setView([38.25267404262653, -85.74790171243315], 12);

        // Defining attributions
        var osmAttribution = 
            'Map data &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> Contributors';
        var leafletRadarAttribution =
            '<a href="https://github.com/rwev/leaflet-radar">Radar</a>';

        // Adding map tile layers with above attributions to the map
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: [
                osmAttribution,
                leafletRadarAttribution
            ].join(" | ")
        }).addTo(map);

        // Creating the sidebar for displaying tag details
        var sidebar = L.control.sidebar('sidebar', {
            position: 'left',
        });
        map.addControl(sidebar)

       // Adding PinSearch component to the map
        var searchBar = L.control.pinSearch({
            position: 'topright',
            placeholder: 'Search is currently broken :(',
            buttonText: 'Search',
            onSearch: function(query) {
                console.log('Search query:', query);
                // Handle the search query here
            },
            searchBarWidth: '200px',
            searchBarHeight: '30px',
            maxSearchResults: 3
        }).addTo(map);

        // Creating marker clusters
        var markers = L.markerClusterGroup();

        // Adding the radar layer to the map
        L.control.radar({}).addTo(map);

        // var panelContent = {
        //     id: 'taginfo',                     // UID, used to access the panel
        //     tab: '<i class="test panel"></i>',  // content can be passed as HTML string,
        //     title: 'Tag Info',                  // an optional pane header
        //     position: 'bottom'     
        // };
        // sidebar.addPanel(panelContent);
    
        Papa.parse("https://raw.githubusercontent.com/ninetyrpm/ninetyrpm.github.io/main/Tags.csv", {
            download: true,
            skipEmptyLines: true,
            header: true,           // csv contains a header row
            complete: function(results) {
                console.log("Papa Parse completed!")
                if (results.errors.length >0){
                    console.error("Error parsing CSV:", results.errors);
                    return;     // Exit the function if errors occurred
                }
                console.log(results.data)
                const jsonData = results.data;      // array containing parsed data objects
                for (const location of jsonData) {
                    const tagNumber = location.TagNum;
                    const name = location.Location;
                    const lat = location.Lat;
                    const lng = location.Long;
                    const tagDt = location.TagDate;
                    const clmDt = location.ClmDate
                    const tagPhotoURL = location.tagURL;
                    const claimPhotoURL = location.claimURL;
                    // console.log(lat, ",", lng)
                    var marker = L.marker([lat,lng], {title: location.Location}).addTo(map);
                    console.log(marker);
                    marker.bindPopup(`<b>${location.TagNum}: ${location.Location}</b>`);
                    marker.on('mouseover',function(e){
                        this.openPopup();
                    });
                    marker.on('mouseout',function(e){
                        this.closePopup();
                    });
                    marker.on('click',function(e){
                        document.getElementById('tag-number').textContent = tagNumber;
                        document.getElementById('location-name').textContent = name;
                        document.getElementById('tag-date').textContent = tagDt;
                        document.getElementById('claim-date').textContent = clmDt;
                        sidebar.show();
                    })
                    map.addLayer(markers);
                }
            }
        });
    </script>
</body>
</html>
